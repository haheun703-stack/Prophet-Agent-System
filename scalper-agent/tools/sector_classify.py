# -*- coding: utf-8 -*-
"""전종목 세부 섹터 분류 — 토스증권 수준"""
import sys, io, json, os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), ".."))
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding="utf-8")
os.chdir(os.path.join(os.path.dirname(__file__), ".."))

with open("data_store/universe.json", "r", encoding="utf-8") as f:
    uni = json.load(f)

# ═══════════════════════════════════════════════════════════
# 코드 직접매핑 — 815개 전부
# ═══════════════════════════════════════════════════════════
M = {
    # ── 반도체 ──
    "005930":"반도체","005935":"반도체","000660":"반도체","000990":"반도체",
    "108320":"반도체","080220":"반도체","046890":"반도체",
    # ── 반도체장비 ──
    "042700":"반도체장비","240810":"반도체장비","039030":"반도체장비","084370":"반도체장비",
    "403870":"반도체장비","036930":"반도체장비","058470":"반도체장비","131290":"반도체장비",
    "098460":"반도체장비","089030":"반도체장비","036540":"반도체장비","440110":"반도체장비",
    "131970":"반도체장비","025950":"반도체장비","222080":"반도체장비","319660":"반도체장비",
    "056190":"반도체장비","089890":"반도체장비","095500":"반도체장비","036810":"반도체장비",
    "161580":"반도체장비","171090":"반도체장비","348210":"반도체장비","399720":"반도체장비",
    "092870":"반도체장비","214430":"반도체장비","086390":"반도체장비","265520":"반도체장비",
    "394280":"반도체장비","094360":"반도체장비","200710":"반도체장비","445090":"반도체장비",
    "420770":"반도체장비","490470":"반도체장비","067310":"반도체장비","110990":"반도체장비",
    "099440":"반도체장비","168360":"반도체장비","053610":"반도체장비","039440":"반도체장비",
    "368770":"반도체장비","101160":"반도체장비","357550":"반도체장비","031980":"반도체장비",
    "484590":"반도체장비","160190":"반도체장비",
    # ── 반도체소재 ──
    "064760":"반도체소재","357780":"반도체소재","005290":"반도체소재","036830":"반도체소재",
    "353200":"반도체소재","007810":"반도체소재","195870":"반도체소재","097520":"반도체소재",
    "090460":"반도체소재","192650":"반도체소재","007660":"반도체소재","248070":"반도체소재",
    "033240":"반도체소재","101490":"반도체소재","077360":"반도체소재","166090":"반도체소재",
    "183300":"반도체소재","074600":"반도체소재","104830":"반도체소재","102710":"반도체소재",
    "222800":"반도체소재","213420":"반도체소재","317330":"반도체소재","253590":"반도체소재",
    "252990":"반도체소재","114810":"반도체소재","356860":"반도체소재","033640":"반도체소재",
    "079370":"반도체소재","036200":"반도체소재","272290":"반도체소재","327260":"반도체소재",
    "489500":"반도체소재","309710":"반도체소재","389500":"반도체소재",
    # ── 2차전지 ──
    "373220":"2차전지","006400":"2차전지","006405":"2차전지","247540":"2차전지",
    "003670":"2차전지","066970":"2차전지","450080":"2차전지","086520":"2차전지",
    "383310":"2차전지","020150":"2차전지","361610":"2차전지","336370":"2차전지",
    "011790":"2차전지","009520":"2차전지","393890":"2차전지","348370":"2차전지",
    "365340":"2차전지","121600":"2차전지","137400":"2차전지","281740":"2차전지",
    "378340":"2차전지","005070":"2차전지","278280":"2차전지","082920":"2차전지",
    "488900":"2차전지","078600":"2차전지","095610":"2차전지","204270":"2차전지",
    "354320":"2차전지","126340":"2차전지","417200":"2차전지",
    # ── 전력기기 ──
    "267260":"전력기기","298040":"전력기기","010120":"전력기기","062040":"전력기기",
    "103590":"전력기기","001440":"전력기기","000500":"전력기기","025540":"전력기기",
    "006340":"전력기기","011690":"전력기기","322000":"전력기기","336260":"전력기기",
    "052690":"전력기기","051600":"전력기기","033100":"전력기기","229640":"전력기기",
    "006910":"전력기기","010170":"전력기기","032820":"전력기기","107640":"전력기기",
    # ── 전력/가스 ──
    "015760":"전력","036460":"전력","071320":"전력","005090":"전력",
    "004690":"전력","017390":"전력",
    # ── 조선 ──
    "329180":"조선","042660":"조선","010140":"조선","009540":"조선","439260":"조선",
    "075580":"조선","082740":"조선","443060":"조선","071970":"조선","060370":"조선",
    "064820":"조선","014940":"조선","097230":"조선","044490":"조선","014620":"조선",
    "101930":"조선",
    # ── 자동차 ──
    "005380":"자동차","000270":"자동차","012330":"자동차","005385":"자동차",
    "005387":"자동차","005389":"자동차",
    # ── 자동차부품 ──
    "204320":"자동차부품","005850":"자동차부품","011210":"자동차부품","003620":"자동차부품",
    "009900":"자동차부품","200880":"자동차부품","007340":"자동차부품","271940":"자동차부품",
    "018880":"자동차부품","064960":"자동차부품","161390":"자동차부품","010690":"자동차부품",
    "091700":"자동차부품","015750":"자동차부품","092200":"자동차부품","009680":"자동차부품",
    "125490":"자동차부품","460930":"자동차부품","187660":"자동차부품","005710":"자동차부품",
    "371950":"자동차부품",
    # ── 방산 ──
    "012450":"방산","064350":"방산","047810":"방산","079550":"방산","272210":"방산",
    "003570":"방산","489790":"방산","319400":"방산","058610":"방산","099320":"방산",
    "274090":"방산","067390":"방산","178320":"방산","496320":"방산",
    # ── 우주항공 ──
    "462350":"우주항공","388720":"우주항공","478340":"우주항공","474170":"우주항공",
    # ── 바이오 ──
    "207940":"바이오","068270":"바이오","196170":"바이오","326030":"바이오","141080":"바이오",
    "298380":"바이오","028300":"바이오","214370":"바이오","310210":"바이오","087010":"바이오",
    "347850":"바이오","0009K0":"바이오","226950":"바이오","068760":"바이오","950160":"바이오",
    "214450":"바이오","145020":"바이오","302440":"바이오","290650":"바이오","397030":"바이오",
    "237690":"바이오","009420":"바이오","115180":"바이오","475830":"바이오","060280":"바이오",
    "138610":"바이오","067630":"바이오","462860":"바이오","039200":"바이오","085660":"바이오",
    "445680":"바이오","082270":"바이오","174900":"바이오","078160":"바이오","048410":"바이오",
    "007390":"바이오","456160":"바이오","096530":"바이오","308430":"바이오","304360":"바이오",
    "376900":"바이오","024850":"바이오","475960":"바이오","389650":"바이오","042520":"바이오",
    "064550":"바이오","099430":"바이오","256840":"바이오","206650":"바이오","340570":"바이오",
    "476830":"바이오","389470":"바이오","358570":"바이오","476060":"바이오","287840":"바이오",
    "372320":"바이오","424870":"바이오","376270":"바이오","228760":"바이오","215600":"바이오",
    "199800":"바이오","338840":"바이오","144510":"바이오","203400":"바이오","084990":"바이오",
    "365270":"바이오","221800":"바이오","494120":"바이오","950210":"바이오","950250":"바이오",
    "180400":"바이오","394800":"바이오","450950":"바이오","065350":"바이오","015360":"바이오",
    "140410":"바이오","102940":"바이오","468530":"바이오","065660":"바이오","900290":"바이오",
    # ── 제약 ──
    "000100":"제약","128940":"제약","000250":"제약","086900":"제약","086450":"제약",
    "249420":"제약","058820":"제약","009290":"제약","053030":"제약","195940":"제약",
    "243070":"제약","084110":"제약","005250":"제약","047920":"제약",
    # ── 의료기기 ──
    "099190":"의료기기","336570":"의료기기","041830":"의료기기","043150":"의료기기",
    "314930":"의료기기","206640":"의료기기","041960":"의료기기","041920":"의료기기",
    "054950":"의료기기","200670":"의료기기","137310":"의료기기","145720":"의료기기",
    "491000":"의료기기","220100":"의료기기",
    # ── 로봇 ──
    "277810":"로봇","454910":"로봇","466100":"로봇","090360":"로봇","270660":"로봇",
    "464080":"로봇","108490":"로봇","348340":"로봇","090710":"로봇","056080":"로봇",
    "459510":"로봇","117730":"로봇","475400":"로봇","079900":"로봇","455900":"로봇",
    # ── AI ──
    "304100":"AI","108860":"AI","486990":"AI","380550":"AI",
    # ── 게임 ──
    "259960":"게임","251270":"게임","036570":"게임","263750":"게임","293490":"게임",
    "225570":"게임","192080":"게임","095660":"게임","112040":"게임","101730":"게임",
    "069080":"게임","078340":"게임","194480":"게임","462870":"게임",
    # ── 엔터/미디어 ──
    "352820":"엔터","041510":"엔터","035900":"엔터","122870":"엔터","253450":"엔터",
    "035760":"엔터","037270":"엔터","419530":"엔터","403850":"엔터","034120":"엔터",
    # ── 인터넷 ──
    "035420":"인터넷","035720":"인터넷","323410":"인터넷","377300":"인터넷","042000":"인터넷",
    "067160":"인터넷","036560":"인터넷","376300":"인터넷","403550":"인터넷",
    # ── IT서비스 ──
    "018260":"IT서비스","307950":"IT서비스","012510":"IT서비스","022100":"IT서비스",
    "064400":"IT서비스","058970":"IT서비스","294570":"IT서비스","060250":"IT서비스",
    "181710":"IT서비스","328130":"IT서비스","052400":"IT서비스","064260":"IT서비스",
    "093320":"IT서비스","030520":"IT서비스","094480":"IT서비스","079940":"IT서비스",
    "215000":"IT서비스","234340":"IT서비스","286940":"IT서비스","012030":"IT서비스",
    "035600":"IT서비스","214180":"IT서비스","298830":"IT서비스","451760":"IT서비스",
    "0007C0":"IT서비스","347700":"IT서비스","124500":"IT서비스","023590":"IT서비스",
    "032190":"IT서비스","170920":"IT서비스","030190":"IT서비스",
    # ── 통신장비 ──
    "032500":"통신장비","218410":"통신장비","050890":"통신장비","189300":"통신장비",
    "388210":"통신장비",
    # ── 통신 ──
    "017670":"통신","030200":"통신","032640":"통신",
    # ── 증권 ──
    "006800":"증권","039490":"증권","005940":"증권","016360":"증권","001720":"증권",
    "003470":"증권","030210":"증권","003530":"증권","030610":"증권","001270":"증권",
    "001500":"증권","00680K":"증권","003540":"증권","003545":"증권","001510":"증권",
    "016610":"증권","001200":"증권","078020":"증권","001750":"증권","005945":"증권",
    "006805":"증권",
    # ── 은행 ──
    "105560":"은행","055550":"은행","086790":"은행","316140":"은행","024110":"은행",
    "175330":"은행","138930":"은행","139130":"은행","006220":"은행",
    # ── 보험 ──
    "000810":"보험","005830":"보험","088350":"보험","001450":"보험","003690":"보험",
    "000155":"보험","000815":"보험","032830":"보험","082640":"보험","085620":"보험",
    "000400":"보험","000370":"보험","031210":"보험",
    # ── 금융지주 ──
    "402340":"금융지주","071050":"금융지주","071055":"금융지주","138040":"금융지주",
    # ── 지주회사 ──
    "034730":"지주회사","003550":"지주회사","000150":"지주회사","006260":"지주회사",
    "078930":"지주회사","001040":"지주회사","004800":"지주회사","010060":"지주회사",
    "0126Z0":"지주회사","009970":"지주회사","000240":"지주회사","008930":"지주회사",
    "004990":"지주회사","267250":"지주회사","005440":"지주회사","003380":"지주회사",
    "001800":"지주회사","012630":"지주회사","036530":"지주회사","006120":"지주회사",
    "192400":"지주회사","002020":"지주회사","007700":"지주회사","000640":"지주회사",
    "383800":"지주회사","003030":"지주회사","005810":"지주회사","000070":"지주회사",
    "072710":"지주회사","060980":"지주회사","015860":"지주회사","027410":"지주회사",
    "084690":"지주회사","024720":"지주회사","000320":"지주회사","096760":"지주회사",
    "030530":"지주회사","002790":"지주회사","035810":"지주회사","092230":"지주회사",
    "00104K":"지주회사","000157":"지주회사",
    # ── 투자/금융 ──
    "100790":"투자","041190":"투자","026890":"투자","241520":"투자","027360":"투자",
    "211050":"금융","123890":"금융","034830":"금융","023760":"금융","244920":"금융",
    "415640":"금융","088980":"금융","094800":"금융","029780":"금융","034310":"금융",
    "034950":"금융",
    # ── 철강 ──
    "005490":"철강","004020":"철강","010130":"철강","103140":"철강","001430":"철강",
    "112610":"철강","017960":"철강","100090":"철강","000670":"철강","058650":"철강",
    "002240":"철강","016380":"철강","084010":"철강","006110":"철강","460860":"철강",
    "002710":"철강","306200":"철강","001940":"철강","104700":"철강","009160":"철강",
    "092790":"철강","012210":"철강","036890":"철강","448900":"철강",
    # ── 화학 ──
    "051910":"화학","096770":"화학","009830":"화학","000880":"화학","011780":"화학",
    "014680":"화학","011170":"화학","457190":"화학","002380":"화학","093370":"화학",
    "011500":"화학","120110":"화학","298020":"화학","004000":"화학","003240":"화학",
    "298050":"화학","285130":"화학","006650":"화학","000210":"화학","014820":"화학",
    "069260":"화학","456040":"화학","002840":"화학","268280":"화학","008730":"화학",
    "005420":"화학","001570":"화학","006380":"화학","178920":"화학","014830":"화학",
    "161000":"화학","138490":"화학","001390":"화학","005720":"화학","025860":"화학",
    "007690":"화학","017860":"화학","001340":"화학","482630":"화학","089980":"화학",
    "101360":"화학","00088K":"화학","051915":"화학","001530":"화학",
    # ── 정유 ──
    "010950":"정유","002960":"정유",
    # ── 타이어 ──
    "002350":"타이어","073240":"타이어",
    # ── 화장품 ──
    "090430":"화장품","278470":"화장품","092730":"화장품","200130":"화장품","192820":"화장품",
    "483650":"화장품","161890":"화장품","241710":"화장품","018290":"화장품","352480":"화장품",
    "251970":"화장품","078520":"화장품","090435":"화장품","018250":"화장품","190510":"화장품",
    # ── 생활용품 ──
    "051900":"생활용품","009240":"생활용품","003800":"생활용품","016800":"생활용품",
    "009450":"생활용품","284740":"생활용품","021240":"생활용품","089860":"생활용품",
    # ── 건설 ──
    "000720":"건설","047040":"건설","375500":"건설","006360":"건설","294870":"건설",
    "009410":"건설","126720":"건설","035890":"건설","045100":"건설","028050":"건설",
    "023410":"건설",
    # ── 식품 ──
    "033780":"식품","003230":"식품","004370":"식품","271560":"식품","097950":"식품",
    "007310":"식품","005300":"식품","000080":"식품","280360":"식품","005180":"식품",
    "001680":"식품","145990":"식품","017810":"식품","005610":"식품","003960":"식품",
    "007160":"식품","003920":"식품","136490":"식품","267980":"식품","136480":"식품",
    "453340":"식품","051500":"식품","475560":"식품","026960":"식품",
    # ── 유통 ──
    "028260":"유통","004170":"유통","139480":"유통","023530":"유통","069960":"유통",
    "282330":"유통","007070":"유통","057050":"유통","031430":"유통","037710":"유통",
    "081660":"유통","257720":"유통","031330":"유통","002810":"유통","036620":"유통",
    "052020":"유통","472850":"유통","481070":"유통","093520":"유통","128820":"유통",
    "008770":"유통","381970":"유통","006730":"유통",
    # ── 무역 ──
    "047050":"무역","095340":"무역","111770":"무역","001120":"무역","001740":"무역",
    # ── 에너지 ──
    "018670":"에너지","017940":"에너지","119850":"에너지","389260":"에너지","475150":"에너지",
    "151860":"에너지","499790":"에너지","416180":"에너지","033500":"에너지","059090":"에너지",
    "100840":"에너지","0001A0":"에너지","448280":"에너지",
    # ── 원자력 ──
    "083650":"원자력","034020":"원자력","130660":"원자력","484870":"원자력",
    # ── 해상운송 ──
    "011200":"해상운송","028670":"해상운송","005880":"해상운송","003280":"해상운송",
    # ── 항공 ──
    "003490":"항공","180640":"항공","020560":"항공","089590":"항공","091810":"항공",
    "272450":"항공",
    # ── 물류 ──
    "086280":"물류","000120":"물류","000650":"물류","002320":"물류","011760":"물류",
    # ── 디스플레이 ──
    "034220":"디스플레이","011070":"디스플레이","318060":"디스플레이",
    # ── 전자부품 ──
    "009150":"전자부품","066570":"전자부품","066575":"전자부품","009155":"전자부품",
    "001820":"전자부품","011930":"전자부품","029530":"전자부품","004490":"전자부품",
    "217590":"전자부품","025320":"전자부품","094170":"전자부품","043260":"전자부품",
    "037460":"전자부품","078350":"전자부품","080580":"전자부품","200470":"전자부품",
    "049630":"전자부품","122640":"전자부품","474650":"전자부품","089010":"전자부품",
    "051370":"전자부품","065680":"전자부품","441270":"전자부품","458870":"전자부품",
    "323280":"전자부품","437730":"전자부품","295310":"전자부품","045390":"전자부품",
    "127120":"전자부품","425420":"전자부품","083450":"전자부품","089970":"전자부품",
    "199430":"전자부품","049070":"전자부품","0008Z0":"전자부품","008060":"전자부품",
    "255220":"전자부품","0015G0":"전자부품",
    # ── 의류 ──
    "383220":"의류","093050":"의류","105630":"의류","004700":"의류","020000":"의류",
    "194370":"의류","001460":"의류","003200":"의류","241590":"의류",
    # ── 레저 ──
    "035250":"레저","032350":"레저","034230":"레저","079160":"레저","114090":"레저",
    "025980":"레저","039130":"레저",
    # ── 광고 ──
    "030000":"광고","214320":"광고","230360":"광고",
    # ── 정밀기기 ──
    "003160":"정밀기기","281820":"정밀기기","105840":"정밀기기","029460":"정밀기기",
    "140860":"정밀기기","013030":"정밀기기",
    # ── 시멘트 ──
    "300720":"시멘트","010780":"시멘트","003300":"시멘트","183190":"시멘트",
    "344820":"시멘트","038500":"시멘트","002030":"시멘트",
    # ── 제지 ──
    "078130":"제지","016590":"제지","002310":"제지",
    # ── 기계 ──
    "267270":"기계","241560":"기계","017800":"기계","077970":"기계",
    "000490":"기계","002900":"기계",
    # ── 보안 ──
    "053800":"보안","236200":"보안","012750":"보안",
    # ── 교육 ──
    "215200":"교육",
    # ── 면세 ──
    "204620":"면세",
    # ── 기타 (분류 어려운 것) ──
    "006040":"에너지",  # 동원산업(참치+에너지)
}

# Apply
mapped = 0
for code, sub in M.items():
    if code in uni:
        uni[code]["sub_sector"] = sub
        mapped += 1

# Check unmapped
unmapped = []
for code, v in uni.items():
    ss = v.get("sub_sector", "")
    if not ss or ss in ("제조","금융","서비스","기타","화학","유통","IT서비스",
        "음식료","기계장비","운송창고","건설","섬유의류","전기전자","전기가스",
        "오락문화","의료정밀","비금속","종이목재","운송장비","금속","금융지주","부동산"):
        unmapped.append((code, v["name"], ss, v["cap_억"]))

# Save
with open("data_store/universe.json", "w", encoding="utf-8") as f:
    json.dump(uni, f, ensure_ascii=False, indent=2)

from collections import Counter
sub_counts = Counter(uni[c].get("sub_sector", "미분류") for c in uni)

print(f"직접매핑: {mapped}개")
print(f"미분류: {len(unmapped)}개")
print(f"\n총 {len(sub_counts)}개 세부섹터:")
for s, cnt in sub_counts.most_common():
    print(f"  {s:14s}: {cnt}개")

if unmapped:
    print(f"\n=== 아직 미분류 {len(unmapped)}개 ===")
    for c, n, s, cap in sorted(unmapped, key=lambda x: -x[3]):
        print(f"  {c} {n:20s} 현재:{s:10s} {cap:>10,}억")
